---
import type { lang } from "@interfaces/lang";

import { twMerge } from "tailwind-merge";

import config from "@data/config.json";

interface Props {
  lang: lang;
  placeHolder: string;
  position: 'desktop' | 'mobile';
  xClass?: string;
}

const { lang, placeHolder, position, xClass } = Astro.props;

const URL_SITEMINDER = config[lang].URL_SITEMINDER;
const desktopBreakpoint = 1365;
---

<date-picker data-urlsiteminder={URL_SITEMINDER} data-lang={lang} data-position={position} data-desktopbreakpoint={desktopBreakpoint} class="w-full max-w-60">
  <input
    placeholder={placeHolder}
    class={twMerge(
      "litepicker-input w-full text-xs text-foreground-1 text-center border-background border-4 rounded-lg py-2 [background:right_center/1.75rem_no-repeat_url(/img/calendar.svg)_white] pr-8 tablet:text-base tablet:[background:right_center/2.5rem_no-repeat_url(/img/calendar.svg)_white]",
      xClass
    )}
  />
</date-picker>


<script>
import Litepicker from 'litepicker';
import 'litepicker/dist/plugins/mobilefriendly';

interface iDate {
  dateInstance: Date,
  lang: string
}

const setLitepicker = (inputField : HTMLInputElement, lang: ('es' | 'en'), urlBase: string) => {

  const tooltipText = (lang === 'es') ? { one: 'noche', other: 'noches' } : { one: 'night', other: 'nights' };
  const firstDay = (lang === 'es') ? 1 : 0;

  new Litepicker({
    // autoRefresh: true,
    element: inputField,
    plugins: ['mobilefriendly'],
    mobilefriendly: {
      breakpoint: 750,
    },
    singleMode: false,
    format: 'MMM DD',
    firstDay,
    lang,
    minDate: new Date(new Date().setDate(new Date().getDate() - 1)),
    numberOfMonths: 2,
    tooltipText,
    
    tooltipNumber: (totalDays : number) => {
      return totalDays - 1;
    },
    setup: (picker: any) => {
      picker.on('selected', (checkInDate : iDate, checkOutDate : iDate) => {

        // https://direct-book.com/properties/HotelLiving35SuitesDirect?locale=es&items[0][adults]=2&items[0][children]=0&items[0][infants]=0&currency=COP&checkInDate=2024-10-02&checkOutDate=2024-10-03&trackPage=yes
        const tmpCheckInDate : Date = checkInDate.dateInstance;
        const strCheckInDate : string = `${tmpCheckInDate.getFullYear().toString()}-${(tmpCheckInDate.getMonth()+1).toString().padStart(2,'0')}-${tmpCheckInDate.getDate().toString().padStart(2,'0')}`;

        const tmpCheckOutDate : Date = checkOutDate.dateInstance;
        const strCheckOutDate : string = `${tmpCheckOutDate.getFullYear().toString()}-${(tmpCheckOutDate.getMonth()+1).toString().padStart(2,'0')}-${tmpCheckOutDate.getDate().toString().padStart(2,'0')}`;

        const btnsBooking : NodeList = document.querySelectorAll('.btnBooking');
        btnsBooking.forEach((value : Node) => {
          const btn : HTMLAnchorElement = value as HTMLAnchorElement;
          btn.href = `${urlBase}&checkInDate=${strCheckInDate}&checkOutDate=${strCheckOutDate}`;
          // console.debug(btn.href);
        })
      });
    },
  });
}


class DatePicker extends HTMLElement {
  connectedCallback() {
    const litepickerInputs = document.querySelectorAll('.litepicker-input');
    if (litepickerInputs)
        // setLitepicker(litepickerInputs as HTMLInputElement, (this.dataset.lang == 'es') ? 'es' : 'en', this.dataset.urlsiteminder ?? '');
      litepickerInputs.forEach((litepicker) => {
        if ((this.dataset.position === 'desktop') && (window.screen.width >= Number(this.dataset.desktopbreakpoint))) {
          setLitepicker(litepicker as HTMLInputElement, (this.dataset.lang == 'es') ? 'es' : 'en', this.dataset.urlsiteminder ?? '');
          // console.debug(this.dataset.position, 'califica 1');
        }
        else {
          if ((this.dataset.position === 'mobile') && (window.screen.width < Number(this.dataset.desktopbreakpoint))) {
            setLitepicker(litepicker as HTMLInputElement, (this.dataset.lang == 'es') ? 'es' : 'en', this.dataset.urlsiteminder ?? '');
            // console.debug(this.dataset.position, 'califica 2');
          }
        }
      })
      
  }
}

customElements.define('date-picker', DatePicker);

</script>